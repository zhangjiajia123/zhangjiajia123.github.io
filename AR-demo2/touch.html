<script src="./js/aframe-master.min.js"></script>
<script src="./js/aframe-ar-nft.js"></script>
<script src="./js/gestures.js"></script>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
</head>
<body style="margin: 0px; overflow: hidden">
  <a-scene
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
    embedded
    renderer="logarithmicDepthBuffer: true;"
    vr-mode-ui="enabled: false"
    gesture-detector
    id="scene"
  >
    <a-marker type="pattern" preset="custom" url="/AR-demo/pattern/marker.patt">
      <a-entity
        gltf-model="/AR-demo/model/smoking_boy/scene.gltf"
        position="0 0 0"
        scale="0.3 0.3 0.3"
        rotation="-90 0 0"
      ></a-entity>
    </a-marker>
    <a-entity camera></a-entity>
  </a-scene>
</body>

<script>
  const scene = document.getElementById("scene");
  scene.addEventListener("loaded", function () {
    // 初始化触摸交互
    initTouchInteraction();
  });
  // 初始化触摸交互
  function initTouchInteraction() {
    const pandaEntity = document.getElementById("panda-model");

    // 添加触摸事件监听
    pandaEntity.addEventListener("touchstart", handleTouchStart);
    pandaEntity.addEventListener("touchend", handleTouchEnd);

    // 添加鼠标事件监听（用于非触摸设备）
    pandaEntity.addEventListener("mousedown", handleTouchStart);
    pandaEntity.addEventListener("mouseup", handleTouchEnd);
  }
  // 处理触摸开始
  function handleTouchStart(event) {
    event.stopPropagation();

    // 添加触摸反馈效果
    const pandaEntity = document.getElementById("panda-model");
    pandaEntity.setAttribute("material", "color: #E0E0E0");

    // 开始计时，判断是否为长按（抚摸）
    this.touchStartTime = Date.now();
  }
  // 处理触摸结束
  function handleTouchEnd(event) {
    event.stopPropagation();

    // 恢复原始颜色
    const pandaEntity = document.getElementById("panda-model");
    pandaEntity.setAttribute("material", "color: #FFFFFF");

    // 计算触摸时长
    const touchDuration = Date.now() - this.touchStartTime;

    // 如果触摸时间超过500ms，认为是抚摸动作
    if (touchDuration > 500) {
      triggerPettingAction();
    }
  }
  // 触发抚摸动作
  function triggerPettingAction() {
    const pandaEntity = document.getElementById("panda-model");

    // 显示爱心粒子效果
    createHeartParticles();

    // 显示信息弹窗
    setTimeout(() => {
      showInfoPanel(
        "熊猫的习性",
        "野生大熊猫是独居动物，每只大熊猫都需要大约4-6平方公里的领地。它们通过气味标记来沟通。"
      );
    }, 1500);
  }
  // 创建爱心粒子效果
  function createHeartParticles() {
    const scene = document.querySelector("a-scene");

    for (let i = 0; i < 5; i++) {
      const heart = document.createElement("a-entity");
      heart.setAttribute(
        "geometry",
        "primitive: plane; width: 0.1; height: 0.1"
      );
      heart.setAttribute("material", "src: #heart-texture; transparent: true;");
      heart.setAttribute("position", "0 0.5 0");

      // 随机动画参数
      const angle = Math.random() * Math.PI * 2;
      const distance = 0.5 + Math.random() * 0.5;
      const targetX = Math.cos(angle) * distance;
      const targetY = 1 + Math.random();
      const targetZ = Math.sin(angle) * distance;

      heart.setAttribute("animation", {
        property: "position",
        to: `${targetX} ${targetY} ${targetZ}`,
        dur: 1500,
        easing: "easeOutQuad",
      });

      heart.setAttribute("animation__opacity", {
        property: "material.opacity",
        from: 1,
        to: 0,
        dur: 1500,
        easing: "easeOutQuad",
      });

      scene.appendChild(heart);

      // 动画完成后移除爱心
      setTimeout(() => {
        if (heart.parentNode) {
          scene.removeChild(heart);
        }
      }, 1600);
    }
  }
</script>
