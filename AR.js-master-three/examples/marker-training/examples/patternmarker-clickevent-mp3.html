<!DOCTYPE html>
<meta
  name="viewport"
  content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
/>
<!-- three.js 3Dæ¸²æŸ“åº“ -->
<script src="../../vendor/three.js/build/three.js"></script>
<script src="../../vendor/three.js/examples/js/libs/stats.min.js"></script>
<!-- ARToolKit å¢å¼ºç°å®åº“ -->
<script src="../../../vendor/jsartoolkit5/build/artoolkit.min.js"></script>
<script src="../../../vendor/jsartoolkit5/js/artoolkit.api.js"></script>
<!-- å¼•å…¥ threex.artoolkit æ‰©å±• -->
<script src="../../../src/threex/threex-artoolkitsource.js"></script>
<script src="../../../src/threex/threex-artoolkitcontext.js"></script>
<script src="../../../src/threex/threex-artoolkitprofile.js"></script>
<script src="../../../src/threex/threex-arbasecontrols.js"></script>
<script src="../../../src/threex/threex-armarkercontrols.js"></script>
<script src="../../../src/threex/threex-arsmoothedcontrols.js"></script>
<script>
  THREEx.ArToolkitContext.baseURL = "../../../";
</script>

<!-- å¼•å…¥å›¾æ¡ˆæ–‡ä»¶å¤„ç† -->
<script src="../threex-arpatternfile.js"></script>
<!-- éƒ¨ç½²æµ‹è¯•ç¯å¢ƒæ—¶æ”¾å¼€ vconsole ç”¨äºæµ‹è¯•  -->
<script src="https://cdn.banyou.70180.cn/assets/xcontent/vconsole/vconsole.min.js"></script>
<script>
  let vConsole = new window.VConsole();
</script>

<body
  style="
    margin: 0px;
    overflow: hidden;
    font-family: Monospace;
    background: black;
  "
>
  <!-- ä½¿ç”¨æç¤º -->
  <div
    id="info"
    style="
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      z-index: 100;
      font-size: 18px;
      border: 2px solid #4fc3f7;
      box-shadow: 0 0 20px rgba(79, 195, 247, 0.5);
    "
  >
    <div style="font-size: 24px; margin-bottom: 15px; color: #4fc3f7">
      ğŸ” ARå¢å¼ºç°å®æ¼”ç¤º
    </div>
    è¯·å°†æ‘„åƒå¤´å¯¹å‡†ARæ ‡è®°å›¾æ¡ˆ<br />
    <small style="color: #b0bec5">æ¨¡å‹å°†åœ¨è¯†åˆ«åˆ°æ ‡è®°åæ˜¾ç¤º</small>
  </div>

  <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
  <div
    id="status"
    style="
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px 15px;
      border-radius: 20px;
      z-index: 100;
      font-size: 14px;
      display: none;
    "
  >
    âœ… æ ‡è®°å·²è¯†åˆ«
  </div>

  <!-- ç‚¹å‡»æç¤º -->
  <div
    id="clickHint"
    style="
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: #4fc3f7;
      padding: 10px 15px;
      border-radius: 20px;
      z-index: 100;
      font-size: 14px;
      display: none;
    "
  >
    ğŸ’¡ ç‚¹å‡»ç²‰è‰²çƒä½“æ’­æ”¾éŸ³é¢‘ï¼
  </div>

  <!-- éŸ³é¢‘çŠ¶æ€ -->
  <div
    id="audioStatus"
    style="
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: #ff9800;
      padding: 10px 15px;
      border-radius: 20px;
      z-index: 100;
      font-size: 14px;
    "
  >
    ï¿½ éŸ³é¢‘åŠ è½½ä¸­...
  </div>

  <!-- ç‚¹å‡»æ•ˆæœæ˜¾ç¤º -->
  <div
    id="clickEffect"
    style="
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #ffeb3b;
      font-size: 48px;
      z-index: 100;
      display: none;
      text-shadow: 0 0 20px rgba(255, 235, 59, 0.8);
      pointer-events: none;
    "
  >
    ğŸ”Š
  </div>

  <!-- è°ƒè¯•ä¿¡æ¯ -->
  <div
    id="debugInfo"
    style="
      position: absolute;
      top: 100px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: #00ff00;
      padding: 10px;
      border-radius: 5px;
      z-index: 100;
      font-size: 12px;
      display: none;
      max-width: 300px;
    "
  >
    è°ƒè¯•ä¿¡æ¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ
  </div>

  <script>
    //////////////////////////////////////////////////////////////////////////////////
    //		éŸ³é¢‘ç®¡ç†
    //////////////////////////////////////////////////////////////////////////////////

    // åˆ›å»ºä¸€ä¸ªAudioContext  
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();  
     
    // å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå¯¹è±¡æ¥å­˜å‚¨åŠ è½½çš„éŸ³é¢‘  
    let audioBuffers = {};
    
    // è·Ÿè¸ªå½“å‰æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘æº
    let currentAudioSource = null;
     
    /**  
     * åŠ è½½éŸ³é¢‘æ–‡ä»¶å¹¶è§£ç ä¸ºAudioBuffer  
     * @param {string} key å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºå­˜å‚¨å’Œæ£€ç´¢AudioBuffer  
     * @param {string} url éŸ³é¢‘æ–‡ä»¶çš„URL  
     * @param {Function} onSuccess æˆåŠŸåŠ è½½å¹¶è§£ç éŸ³é¢‘åçš„å›è°ƒå‡½æ•°ï¼ˆå¯é€‰ï¼‰  
     * @param {Function} onError åŠ è½½æˆ–è§£ç éŸ³é¢‘æ—¶å‘ç”Ÿé”™è¯¯çš„å›è°ƒå‡½æ•°ï¼ˆå¯é€‰ï¼‰  
     */  
    function loadAudio(key, url, onSuccess, onError) {  
        if (audioBuffers[key]) {  
            // å¦‚æœå·²ç»åŠ è½½è¿‡ï¼Œç›´æ¥è°ƒç”¨æˆåŠŸå›è°ƒï¼ˆå¦‚æœæœ‰ï¼‰  
            if (onSuccess) {  
                onSuccess(audioBuffers[key]);  
            }  
            return; // æå‰é€€å‡ºå‡½æ•°  
        }  
     
        fetch(url)  
            .then(response => {  
                console.log(response, 'response')
                if (!response.ok) {  
                    throw new Error('Network response was not ok');  
                }  
                return response.arrayBuffer();  
            })  
            .then(arrayBuffer => audioCtx.decodeAudioData(arrayBuffer))  
            .then(audioBuffer => {  
                // å­˜å‚¨AudioBufferåˆ°å¯¹è±¡ä¸­  
                audioBuffers[key] = audioBuffer;  
     
                // è°ƒç”¨æˆåŠŸå›è°ƒå‡½æ•°ï¼ˆå¦‚æœæœ‰ï¼‰  
                if (onSuccess) {  
                    onSuccess(audioBuffer);  
                }  
            })  
            .catch(error => {  
                // è°ƒç”¨é”™è¯¯å›è°ƒå‡½æ•°ï¼ˆå¦‚æœæœ‰ï¼‰  
                if (onError) {  
                    onError(error);  
                } else {  
                    console.error('Error loading and decoding audio:', error);  
                }  
            });  
    }  
     
    /**  
     * æ’­æ”¾å·²åŠ è½½çš„éŸ³é¢‘  
     * @param {string} key å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºæ£€ç´¢AudioBuffer  
     */  
    function playAudio(key) {  
        const audioBuffer = audioBuffers[key];  
        if (!audioBuffer) {  
            console.error('Audio buffer not found for key:', key);  
            return;  
        }  
     
        // å¦‚æœæœ‰æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘ï¼Œå…ˆåœæ­¢å®ƒ
        if (currentAudioSource) {
            try {
                currentAudioSource.stop();
                console.log('å·²åœæ­¢ä¸Šä¸€ä¸ªéŸ³é¢‘');
                debugLog('å·²åœæ­¢ä¸Šä¸€ä¸ªéŸ³é¢‘');
            } catch (error) {
                console.log('åœæ­¢éŸ³é¢‘æ—¶å‡ºé”™:', error);
            }
            currentAudioSource = null;
        }
     
        // åˆ›å»ºä¸€ä¸ªAudioBufferSourceNodeæ¥æ’­æ”¾éŸ³é¢‘  
        const source = audioCtx.createBufferSource();  
        source.buffer = audioBuffer;  
        source.connect(audioCtx.destination); // è¿æ¥åˆ°è¾“å‡ºï¼ˆæ‰¬å£°å™¨ï¼‰  
     
        // ç›‘å¬éŸ³é¢‘æ’­æ”¾ç»“æŸäº‹ä»¶
        source.onended = function() {
            console.log('éŸ³é¢‘æ’­æ”¾å®Œæˆ');
            currentAudioSource = null;
        };
        
        // ä¿å­˜å½“å‰éŸ³é¢‘æºçš„å¼•ç”¨
        currentAudioSource = source;
     
        // æ’­æ”¾éŸ³é¢‘  
        source.start();
        console.log('å¼€å§‹æ’­æ”¾æ–°éŸ³é¢‘');
        debugLog('å¼€å§‹æ’­æ”¾æ–°éŸ³é¢‘');
    }

    // éŸ³é¢‘çŠ¶æ€
    var audioEnabled = false;
    var audioLoaded = false;

    // åˆå§‹åŒ–éŸ³é¢‘ç³»ç»Ÿ
    // '/AR.js-master-three/sounds/click.mp3',
    function initAudio() {
      try {
        // æ¢å¤éŸ³é¢‘ä¸Šä¸‹æ–‡ï¼ˆå¦‚æœè¢«æš‚åœï¼‰
        if (audioCtx.state === 'suspended') {
          audioCtx.resume().then(() => {
            console.log("AudioContext resumed");
          });
        }
        
        // åŠ è½½ç‚¹å‡»éŸ³æ•ˆ
        loadAudio(
          'clickSound',
          'https://cdn.banyou.70180.cn/assets/xfile/ZhbyJingquSpot/upload/20251106054749892_çº¢å¤§é¾™è™¾å—äº¬çª—ç¢ç‰‡.MP3',
          function(audioBuffer) {
            console.log("MP3éŸ³é¢‘åŠ è½½æˆåŠŸ");
            audioLoaded = true;
            audioEnabled = true;
            document.getElementById('audioStatus').innerHTML = "ğŸ”Š éŸ³é¢‘å·²åŠ è½½";
            document.getElementById('audioStatus').style.color = "#00ff00";
            debugLog("MP3éŸ³é¢‘å·²å°±ç»ª");
          },
          function(error) {
            console.error("MP3éŸ³é¢‘åŠ è½½å¤±è´¥:", error);
            debugLog("éŸ³é¢‘åŠ è½½å¤±è´¥: " + error.message);
            // å³ä½¿å¤±è´¥ä¹Ÿå…è®¸ç‚¹å‡»ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
            audioEnabled = true;
            createFallbackSound();
          }
        );
        
      } catch (error) {
        console.error("éŸ³é¢‘åˆå§‹åŒ–å¤±è´¥:", error);
        debugLog("éŸ³é¢‘åˆå§‹åŒ–å¤±è´¥: " + error.message);
        audioEnabled = true; // å…è®¸ç‚¹å‡»ï¼Œåªæ˜¯æ²¡æœ‰å£°éŸ³
      }
    }

    // åˆ›å»ºå¤‡ç”¨éŸ³æ•ˆ
    function createFallbackSound() {
      try {
        // åˆ›å»ºä¸€ä¸ªç®€å•çš„å¤‡ç”¨éŸ³æ•ˆ
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        
        oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.3);
        
        gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
        
        oscillator.start(audioCtx.currentTime);
        oscillator.stop(audioCtx.currentTime + 0.3);
        
        // å­˜å‚¨å¤‡ç”¨éŸ³æ•ˆ
        audioBuffers['fallbackSound'] = true;
        console.log("å¤‡ç”¨éŸ³æ•ˆåˆ›å»ºæˆåŠŸ");
        
      } catch (fallbackError) {
        console.error("å¤‡ç”¨éŸ³æ•ˆåˆ›å»ºå¤±è´¥:", fallbackError);
      }
    }

    // æ’­æ”¾ç‚¹å‡»éŸ³æ•ˆ
    function playClickSound() {
      // å¦‚æœAudioContextè¢«æš‚åœï¼Œå°è¯•æ¢å¤
      if (audioCtx.state === 'suspended') {
        audioCtx.resume().then(() => {
          console.log("AudioContext resumed on play");
          playAudioInternal();
        });
      } else {
        playAudioInternal();
      }
    }
    
    function playAudioInternal() {
      if (!audioEnabled) {
        debugLog("éŸ³é¢‘æœªå¯ç”¨");
        return;
      }
      
      try {
        console.log("å°è¯•æ’­æ”¾éŸ³é¢‘");
        
        if (audioBuffers['clickSound']) {
          // æ’­æ”¾MP3éŸ³é¢‘
          playAudio('clickSound');
          console.log("MP3éŸ³é¢‘æ’­æ”¾æˆåŠŸ");
          debugLog("MP3éŸ³é¢‘æ’­æ”¾æˆåŠŸ");
        } else if (audioBuffers['fallbackSound']) {
          // æ’­æ”¾å¤‡ç”¨éŸ³æ•ˆ
          createFallbackSound();
          console.log("æ’­æ”¾å¤‡ç”¨éŸ³æ•ˆ");
          debugLog("æ’­æ”¾å¤‡ç”¨éŸ³æ•ˆ");
        } else {
          console.log("æ²¡æœ‰å¯ç”¨çš„éŸ³æ•ˆ");
          debugLog("æ²¡æœ‰å¯ç”¨çš„éŸ³æ•ˆ");
        }
      } catch (error) {
        console.error("æ’­æ”¾éŸ³æ•ˆå¤±è´¥:", error);
        debugLog("æ’­æ”¾å¤±è´¥: " + error.message);
      }
    }

    // ç”¨æˆ·äº¤äº’ååˆå§‹åŒ–éŸ³é¢‘ï¼ˆå·²åºŸå¼ƒï¼Œæ”¹ä¸ºé¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ï¼‰
    function initAudioOnUserInteraction() {
      // å¦‚æœéŸ³é¢‘ä¸Šä¸‹æ–‡è¢«æš‚åœï¼Œå°è¯•æ¢å¤
      if (audioCtx.state === 'suspended') {
        audioCtx.resume().then(() => {
          console.log("AudioContext resumed on interaction");
        });
      }
    }

    //////////////////////////////////////////////////////////////////////////////////
    //		åˆå§‹åŒ–
    //////////////////////////////////////////////////////////////////////////////////

    // åˆå§‹åŒ–WebGLæ¸²æŸ“å™¨
    var renderer = new THREE.WebGLRenderer({
      alpha: true,
      antialias: true,
      preserveDrawingBuffer: true,
    });

    // è®¾ç½®æ¸²æŸ“å™¨ä¸ºå…¨å±
    renderer.setClearColor(new THREE.Color("black"), 0);
    renderer.setPixelRatio(window.devicePixelRatio || 1);
    renderer.setSize(window.innerWidth, window.innerHeight);

    // è®¾ç½®æ¸²æŸ“å™¨DOMå…ƒç´ æ ·å¼ä¸ºå…¨å±è¦†ç›–
    renderer.domElement.style.position = "fixed";
    renderer.domElement.style.top = "0px";
    renderer.domElement.style.left = "0px";
    renderer.domElement.style.width = "100%";
    renderer.domElement.style.height = "100%";
    renderer.domElement.style.zIndex = "1";

    // å°†æ¸²æŸ“å™¨æ·»åŠ åˆ°é¡µé¢
    document.body.appendChild(renderer.domElement);

    // æ¸²æŸ“å¾ªç¯å‡½æ•°æ•°ç»„
    var onRenderFcts = [];

    // åˆå§‹åŒ–3Dåœºæ™¯
    var scene = new THREE.Scene();

    // æ·»åŠ ç¯å¢ƒå…‰
    var ambient = new THREE.AmbientLight(0x666666);
    scene.add(ambient);

    // æ·»åŠ å®šå‘å…‰
    var directionalLight = new THREE.DirectionalLight(0x887766);
    directionalLight.position.set(-1, 1, 1).normalize();
    scene.add(directionalLight);

    //////////////////////////////////////////////////////////////////////////////////
    //		åˆå§‹åŒ–åŸºç¡€ç›¸æœº
    //////////////////////////////////////////////////////////////////////////////////

    // åˆ›å»ºThree.jsç›¸æœº
    var camera = new THREE.Camera();
    scene.add(camera);

    // å°„çº¿æŠ•å°„å™¨
    var raycaster = new THREE.Raycaster();
    var mouse = new THREE.Vector2();

    // å­˜å‚¨å¯ç‚¹å‡»çš„ç‰©ä½“
    var clickableObjects = [];

    // è°ƒè¯•å‡½æ•°
    function debugLog(message) {
      // console.log(message);
      var debugElement = document.getElementById('debugInfo');
      if (debugElement) {
        debugElement.innerHTML = message;
        debugElement.style.display = 'block';
      }
    }

    ////////////////////////////////////////////////////////////////////////////////
    //         å¤„ç†ARè§†é¢‘æº
    ////////////////////////////////////////////////////////////////////////////////

    var arToolkitSource = new THREEx.ArToolkitSource({
      sourceType: "webcam",
    });

    arToolkitSource.init(function onReady() {
      console.log("æ‘„åƒå¤´åˆå§‹åŒ–å®Œæˆ");

      if (arToolkitSource.domElement) {
        arToolkitSource.domElement.style.position = "fixed";
        arToolkitSource.domElement.style.top = "0px";
        arToolkitSource.domElement.style.left = "0px";
        arToolkitSource.domElement.style.width = "100%";
        arToolkitSource.domElement.style.height = "100%";
        arToolkitSource.domElement.style.objectFit = "cover";
        arToolkitSource.domElement.style.zIndex = "0";
      }

      arToolkitSource.onResizeElement(
        [
          renderer.domElement,
          arToolkitContext.arController
            ? arToolkitContext.arController.canvas
            : null,
        ].filter(Boolean)
      );
    });

    window.addEventListener("resize", function () {
      renderer.setSize(window.innerWidth, window.innerHeight);
      arToolkitSource.onResizeElement(
        [
          renderer.domElement,
          arToolkitContext.arController
            ? arToolkitContext.arController.canvas
            : null,
        ].filter(Boolean)
      );
    });

    ////////////////////////////////////////////////////////////////////////////////
    //         åˆå§‹åŒ–ARä¸Šä¸‹æ–‡
    ////////////////////////////////////////////////////////////////////////////////

    var arToolkitContext = new THREEx.ArToolkitContext({
      cameraParametersUrl: "../../../data/data/camera_para.dat",
      detectionMode: "mono",
      maxDetectionRate: 60,
      canvasWidth: 1280,
      canvasHeight: 720,
      debug: false,
    });

    arToolkitContext.init(function onCompleted() {
      console.log("ARä¸Šä¸‹æ–‡åˆå§‹åŒ–å®Œæˆ");
      camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
    });

    onRenderFcts.push(function () {
      if (arToolkitSource.ready === false) return;
      arToolkitContext.update(arToolkitSource.domElement);
    });

    ////////////////////////////////////////////////////////////////////////////////
    //         åˆ›å»ºARæ ‡è®°æ§åˆ¶å™¨
    ////////////////////////////////////////////////////////////////////////////////

    var markerRoot = new THREE.Group();
    markerRoot.visible = false;
    scene.add(markerRoot);

    var markerControls = new THREEx.ArMarkerControls(
      arToolkitContext,
      markerRoot,
      {
        type: "pattern",
        patternUrl: "/AR.js-master-three/data/data/marker.patt",
        size: 1.0,
        smooth: true,
        smoothCount: 5,
        smoothTolerance: 0.01,
        smoothThreshold: 2,
      }
    );

    markerControls.addEventListener("markerFound", function () {
      console.log("âœ… æ ‡è®°è¯†åˆ«æˆåŠŸ");
      document.getElementById("info").style.display = "none";
      document.getElementById("status").style.display = "block";
      document.getElementById("clickHint").style.display = "block";
      markerRoot.visible = true;
      debugLog("æ ‡è®°è¯†åˆ«æˆåŠŸï¼å¯ä»¥ç‚¹å‡»çƒä½“äº†");
    });

    markerControls.addEventListener("markerLost", function () {
      console.log("âŒ æ ‡è®°ä¸¢å¤±");
      document.getElementById("status").style.display = "none";
      document.getElementById("info").style.display = "block";
      document.getElementById("clickHint").style.display = "none";
      markerRoot.visible = false;
      debugLog("æ ‡è®°ä¸¢å¤±");
    });

    ////////////////////////////////////////////////////////////////////////////////
    //         åˆ›å»ºå¹³æ»‘æ§åˆ¶å™¨
    ////////////////////////////////////////////////////////////////////////////////

    var smoothedRoot = new THREE.Group();
    smoothedRoot.visible = false;
    scene.add(smoothedRoot);

    var smoothedControls = new THREEx.ArSmoothedControls(smoothedRoot, {
      minVisibleDelay: 0.3,
      minUnvisibleDelay: 0.5,
      smoothDelay: 0.1,
      smoothPosition: 0.8,
      smoothRotation: 0.8,
    });

    smoothedControls.addEventListener("becameVisible", function () {
      console.log("ğŸ‘ï¸ æ¨¡å‹å˜ä¸ºå¯è§");
      smoothedRoot.visible = true;
      debugLog("3Dæ¨¡å‹å·²æ˜¾ç¤º");
    });

    smoothedControls.addEventListener("becameUnVisible", function () {
      console.log("ğŸ™ˆ æ¨¡å‹å˜ä¸ºä¸å¯è§");
      smoothedRoot.visible = false;
      debugLog("3Dæ¨¡å‹å·²éšè—");
    });

    onRenderFcts.push(function (delta) {
      smoothedControls.update(markerRoot);
    });

    //////////////////////////////////////////////////////////////////////////////////
    //		åœ¨åœºæ™¯ä¸­æ·»åŠ 3Dç‰©ä½“
    //////////////////////////////////////////////////////////////////////////////////

    // var torusGeometry = new THREE.TorusKnotGeometry(0.3, 0.1, 128, 32);
    // var torusMaterial = new THREE.MeshPhongMaterial({
    //   color: 0xff9800,
    //   shininess: 100,
    //   specular: 0x222222,
    // });
    // var torus = new THREE.Mesh(torusGeometry, torusMaterial);
    // torus.position.y = 0.8;
    // smoothedRoot.add(torus);

    var sphereGeometry = new THREE.SphereGeometry(0.2, 32, 32);
    var sphereMaterial = new THREE.MeshPhongMaterial({
      color: 0xe91e63,
      shininess: 100,
      emissive: 0xe91e63,
      emissiveIntensity: 0.3,
    });
    var sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
    sphere.position.set(0.5, 0.5, 0.3);
    
    sphere.userData = { 
      clickable: true, 
      originalColor: 0xe91e63,
      originalScale: 1,
      name: "clickableSphere"
    };
    
    smoothedRoot.add(sphere);
    clickableObjects.push(sphere);

    // var platformGeometry = new THREE.CylinderGeometry(0.25, 0.25, 0.05, 16);
    // var platformMaterial = new THREE.MeshPhongMaterial({
    //   color: 0x4fc3f7,
    //   transparent: true,
    //   opacity: 0.8,
    // });
    // var platform = new THREE.Mesh(platformGeometry, platformMaterial);
    // platform.position.set(0.5, 0.3, 0.3);
    // smoothedRoot.add(platform);

    var sphereClicked = false;
    var clickAnimationTime = 0;

    var animationTime = 0;
    onRenderFcts.push(function (delta) {
      animationTime += delta;

      // torus.rotation.x = animationTime * 0.5;
      // torus.rotation.y = animationTime * 0.8;

      if (!sphereClicked) {
        sphere.position.y = 0.5 + Math.sin(animationTime * 2) * 0.1;
      } else {
        clickAnimationTime += delta;
        sphere.rotation.x = clickAnimationTime * 3;
        sphere.rotation.y = clickAnimationTime * 2;
        sphere.scale.setScalar(1 + Math.sin(clickAnimationTime * 5) * 0.2);
      }

      sphere.rotation.z = animationTime * 0.5;
    });

    //////////////////////////////////////////////////////////////////////////////////
    //		æ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†
    //////////////////////////////////////////////////////////////////////////////////

    function checkSphereClick(event) {
      // event.preventDefault();
      
      // åˆå§‹åŒ–éŸ³é¢‘
      initAudioOnUserInteraction();
      
      var mouseX = (event.clientX / window.innerWidth) * 2 - 1;
      var mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
      
      debugLog(`ç‚¹å‡»ä½ç½®: x=${mouseX.toFixed(2)}, y=${mouseY.toFixed(2)}`);

      var sphereWorldPos = new THREE.Vector3();
      sphere.getWorldPosition(sphereWorldPos);
      
      var screenPos = sphereWorldPos.clone();
      screenPos.project(camera);
      
      var screenX = (screenPos.x + 1) / 2 * window.innerWidth;
      var screenY = (-screenPos.y + 1) / 2 * window.innerHeight;
      
      debugLog(`çƒä½“ä½ç½®: x=${screenX.toFixed(0)}, y=${screenY.toFixed(0)}`);

      var distance = Math.sqrt(
        Math.pow(event.clientX - screenX, 2) + 
        Math.pow(event.clientY - screenY, 2)
      );
      
      debugLog(`ç‚¹å‡»è·ç¦»: ${distance.toFixed(0)}px`);

      if (distance < 50) {
        handleSphereClick(sphere);
        debugLog("âœ… æˆåŠŸç‚¹å‡»çƒä½“ï¼");
      } else {
        debugLog("âŒ æœªç‚¹å‡»åˆ°çƒä½“");
      }
    }

    function handleSphereClick(sphere) {
      console.log("ğŸ¯ çƒä½“è¢«ç‚¹å‡»äº†ï¼");
      
      // æ’­æ”¾éŸ³æ•ˆ
      playClickSound();
      
      sphereClicked = !sphereClicked;
      
      showClickEffect();
      
      if (sphereClicked) {
        sphere.material.color.set(0x00ff00);
        sphere.material.emissive.set(0x00ff00);
        sphere.material.emissiveIntensity = 0.5;
        sphere.userData.originalScale = sphere.scale.x;
        document.getElementById("clickHint").innerHTML = "ğŸ’š å†æ¬¡ç‚¹å‡»æ¢å¤åŸçŠ¶";
        document.getElementById("clickHint").style.color = "#00ff00";
      } else {
        sphere.material.color.set(sphere.userData.originalColor);
        sphere.material.emissive.set(sphere.userData.originalColor);
        sphere.material.emissiveIntensity = 0.3;
        sphere.scale.setScalar(sphere.userData.originalScale);
        document.getElementById("clickHint").innerHTML = "ğŸ’¡ ç‚¹å‡»ç²‰è‰²çƒä½“æ’­æ”¾éŸ³é¢‘ï¼";
        document.getElementById("clickHint").style.color = "#4fc3f7";
      }
    }

    function showClickEffect() {
      var effectElement = document.getElementById("clickEffect");
      effectElement.style.display = "block";
      effectElement.style.opacity = "1";
      effectElement.style.transform = "translate(-50%, -50%) scale(1)";
      
      var startTime = Date.now();
      var duration = 1000;
      
      function animateEffect() {
        var elapsed = Date.now() - startTime;
        var progress = elapsed / duration;
        
        if (progress < 1) {
          effectElement.style.transform = `translate(-50%, -50%) scale(${1 + progress * 0.5})`;
          effectElement.style.opacity = (1 - progress).toString();
          requestAnimationFrame(animateEffect);
        } else {
          effectElement.style.display = "none";
        }
      }
      
      animateEffect();
    }

    // æ·»åŠ å…¨å±€ç‚¹å‡»äº‹ä»¶æ¥å¯ç”¨éŸ³é¢‘
    document.addEventListener('click', function(event) {
      initAudioOnUserInteraction();
    });

    // çƒä½“ç‚¹å‡»äº‹ä»¶
    window.addEventListener("click", checkSphereClick, false);

    // è§¦æ‘¸è®¾å¤‡æ”¯æŒ
    window.addEventListener("touchstart", function(event) {
      if (event.touches.length === 1) {
        checkSphereClick(event.touches[0]);
      }
    }, false);

    //////////////////////////////////////////////////////////////////////////////////
    //		æ¸²æŸ“åœºæ™¯
    //////////////////////////////////////////////////////////////////////////////////

    var stats = new Stats();
    stats.dom.style.position = "fixed";
    stats.dom.style.top = "60px";
    stats.dom.style.left = "10px";
    stats.dom.style.zIndex = "100";
    document.body.appendChild(stats.dom);

    onRenderFcts.push(function () {
      renderer.render(scene, camera);
      stats.update();
    });

    var lastTimeMsec = null;
    requestAnimationFrame(function animate(nowMsec) {
      requestAnimationFrame(animate);
      lastTimeMsec = lastTimeMsec || nowMsec - 1000 / 60;
      var deltaMsec = Math.min(200, nowMsec - lastTimeMsec);
      lastTimeMsec = nowMsec;
      onRenderFcts.forEach(function (onRenderFct) {
        onRenderFct(deltaMsec / 1000, nowMsec / 1000);
      });
    });

    document.addEventListener("visibilitychange", function () {
      if (!document.hidden) {
        console.log("é¡µé¢é‡æ–°æ¿€æ´»ï¼Œé‡æ–°åˆå§‹åŒ–AR");
        arToolkitSource.init(function onReady() {
          arToolkitSource.onResizeElement(
            [
              renderer.domElement,
              arToolkitContext.arController
                ? arToolkitContext.arController.canvas
                : null,
            ].filter(Boolean)
          );
        });
      }
    });

    console.log("ARåº”ç”¨åˆå§‹åŒ–å®Œæˆ");
    debugLog("åº”ç”¨å·²å¯åŠ¨");
    
    // é¡µé¢åŠ è½½å®Œæˆåç«‹å³åˆå§‹åŒ–éŸ³é¢‘
    window.addEventListener('load', function() {
      console.log("é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–éŸ³é¢‘");
      initAudio();
    });
    
    // å¦‚æœloadäº‹ä»¶å·²ç»è§¦å‘ï¼Œç«‹å³åˆå§‹åŒ–
    if (document.readyState === 'complete') {
      console.log("é¡µé¢å·²åŠ è½½ï¼Œç«‹å³åˆå§‹åŒ–éŸ³é¢‘");
      initAudio();
    }
  </script>
</body>