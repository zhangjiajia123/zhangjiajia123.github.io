<!DOCTYPE html>
<meta
  name="viewport"
  content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
/>
<!-- three.js 3Dæ¸²æŸ“åº“ -->
<script src="../../vendor/three.js/build/three.js"></script>
<script src="../../vendor/three.js/examples/js/libs/stats.min.js"></script>
<!-- ARToolKit å¢å¼ºç°å®åº“ -->
<script src="../../../vendor/jsartoolkit5/build/artoolkit.min.js"></script>
<script src="../../../vendor/jsartoolkit5/js/artoolkit.api.js"></script>
<!-- å¼•å…¥ threex.artoolkit æ‰©å±• -->
<script src="../../../src/threex/threex-artoolkitsource.js"></script>
<script src="../../../src/threex/threex-artoolkitcontext.js"></script>
<script src="../../../src/threex/threex-artoolkitprofile.js"></script>
<script src="../../../src/threex/threex-arbasecontrols.js"></script>
<script src="../../../src/threex/threex-armarkercontrols.js"></script>
<script src="../../../src/threex/threex-arsmoothedcontrols.js"></script>
<script>
  THREEx.ArToolkitContext.baseURL = "../../../";
</script>

<!-- å¼•å…¥å›¾æ¡ˆæ–‡ä»¶å¤„ç† -->
<script src="../threex-arpatternfile.js"></script>
<!-- éƒ¨ç½²æµ‹è¯•ç¯å¢ƒæ—¶æ”¾å¼€ vconsole ç”¨äºæµ‹è¯•  -->
<script src="https://cdn.banyou.70180.cn/assets/xcontent/vconsole/vconsole.min.js"></script>
<script>
  let vConsole = new window.VConsole();
</script>

<body
  style="
    margin: 0px;
    overflow: hidden;
    font-family: Monospace;
    background: black;
  "
>
  <!-- ä½¿ç”¨æç¤º -->
  <div
    id="info"
    style="
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      z-index: 100;
      font-size: 18px;
      border: 2px solid #4fc3f7;
      box-shadow: 0 0 20px rgba(79, 195, 247, 0.5);
    "
  >
    <div style="font-size: 24px; margin-bottom: 15px; color: #4fc3f7">
      ğŸ” ARå¢å¼ºç°å®æ¼”ç¤º
    </div>
    è¯·å°†æ‘„åƒå¤´å¯¹å‡†ARæ ‡è®°å›¾æ¡ˆ<br />
    <small style="color: #b0bec5">æ¨¡å‹å°†åœ¨è¯†åˆ«åˆ°æ ‡è®°åæ˜¾ç¤º</small>
    <br />
    <small style="color: #ff9800">ç‚¹å‡»é¡µé¢ä»»æ„ä½ç½®å¯ç”¨éŸ³é¢‘</small>
  </div>

  <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
  <div
    id="status"
    style="
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px 15px;
      border-radius: 20px;
      z-index: 100;
      font-size: 14px;
      display: none;
    "
  >
    âœ… æ ‡è®°å·²è¯†åˆ«
  </div>

  <!-- ç‚¹å‡»æç¤º -->
  <div
    id="clickHint"
    style="
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: #4fc3f7;
      padding: 10px 15px;
      border-radius: 20px;
      z-index: 100;
      font-size: 14px;
      display: none;
    "
  >
    ğŸ’¡ ç‚¹å‡»ç²‰è‰²çƒä½“æ’­æ”¾éŸ³é¢‘ï¼
  </div>

  <!-- éŸ³é¢‘çŠ¶æ€ -->
  <div
    id="audioStatus"
    style="
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: #ff9800;
      padding: 10px 15px;
      border-radius: 20px;
      z-index: 100;
      font-size: 14px;
    "
  >
    ğŸ”‡ ç‚¹å‡»é¡µé¢å¯ç”¨éŸ³é¢‘
  </div>

  <!-- ç‚¹å‡»æ•ˆæœæ˜¾ç¤º -->
  <div
    id="clickEffect"
    style="
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #ffeb3b;
      font-size: 48px;
      z-index: 100;
      display: none;
      text-shadow: 0 0 20px rgba(255, 235, 59, 0.8);
      pointer-events: none;
    "
  >
    ğŸ”Š
  </div>

  <!-- è°ƒè¯•ä¿¡æ¯ -->
  <div
    id="debugInfo"
    style="
      position: absolute;
      top: 100px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: #00ff00;
      padding: 10px;
      border-radius: 5px;
      z-index: 100;
      font-size: 12px;
      display: none;
      max-width: 300px;
    "
  >
    è°ƒè¯•ä¿¡æ¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ
  </div>

  <!-- éšè—çš„éŸ³é¢‘å…ƒç´  -->
  <audio id="clickSound" preload="auto">
    <!-- ä½¿ç”¨ç›¸å¯¹è·¯å¾„ -->
    <source src="../../../sounds/click.mp3" type="audio/mpeg">
    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘å…ƒç´ ã€‚
  </audio>

  <script>
    //////////////////////////////////////////////////////////////////////////////////
    //		éŸ³é¢‘ç®¡ç† - ä½¿ç”¨æœ¬åœ°MP3æ–‡ä»¶
    //////////////////////////////////////////////////////////////////////////////////

    // éŸ³é¢‘çŠ¶æ€
    var audioEnabled = false;
    var audioLoaded = false;
    var clickAudio = null;

    // åˆå§‹åŒ–éŸ³é¢‘ç³»ç»Ÿ
    function initAudio() {
      try {
        // æ˜¾ç¤ºéŸ³é¢‘è°ƒè¯•ä¿¡æ¯
        debugLog("å¼€å§‹åˆå§‹åŒ–éŸ³é¢‘ç³»ç»Ÿ...");
        
        // è·å–éŸ³é¢‘å…ƒç´ 
        clickAudio = document.getElementById('clickSound');
        console.log("éŸ³é¢‘å…ƒç´ :", clickAudio);
        if (!clickAudio) {
          console.error("æœªæ‰¾åˆ°éŸ³é¢‘å…ƒç´ ");
          debugLog("é”™è¯¯ï¼šæœªæ‰¾åˆ°éŸ³é¢‘å…ƒç´ ");
          return;
        }
        
        // è®¾ç½®éŸ³é¢‘å±æ€§
        clickAudio.volume = 0.7;
        
        // æ˜¾ç¤ºéŸ³é¢‘æ–‡ä»¶è·¯å¾„
        var source = clickAudio.querySelector('source');
        if (source) {
          debugLog("éŸ³é¢‘æ–‡ä»¶è·¯å¾„: " + source.src);
        }
        
        // æ£€æŸ¥éŸ³é¢‘æ˜¯å¦åŠ è½½æˆåŠŸ
        var loadPromise = new Promise(function(resolve, reject) {
          // å¦‚æœéŸ³é¢‘å·²ç»å¯ä»¥æ’­æ”¾
          if (clickAudio.readyState >= 3) {
            console.log("éŸ³é¢‘å·²å‡†å¤‡å°±ç»ª");
            resolve();
            return;
          }
          
          clickAudio.addEventListener('canplaythrough', function() {
            console.log("éŸ³é¢‘å¯ä»¥æ’­æ”¾");
            resolve();
          }, { once: true });
          
          clickAudio.addEventListener('error', function(e) {
            console.error('éŸ³é¢‘åŠ è½½å¤±è´¥:', e);
            var errorCode = clickAudio.error ? clickAudio.error.code : 'unknown';
            var errorMessages = {
              1: 'ç”¨æˆ·ä¸­æ­¢äº†è·å–è¿‡ç¨‹',
              2: 'ç½‘ç»œé”™è¯¯',
              3: 'è§£ç é”™è¯¯',
              4: 'ä¸æ”¯æŒçš„éŸ³é¢‘æ ¼å¼'
            };
            var errorMsg = errorMessages[errorCode] || 'æœªçŸ¥é”™è¯¯';
            console.log('éŸ³é¢‘é”™è¯¯è¯¦æƒ…:', errorCode, errorMsg);
            reject(new Error('éŸ³é¢‘åŠ è½½å¤±è´¥: ' + errorMsg));
          });
          
          clickAudio.addEventListener('load', function() {
            console.log("éŸ³é¢‘åŠ è½½äº‹ä»¶è§¦å‘");
          });
          
          // ä¸»åŠ¨å°è¯•åŠ è½½
          clickAudio.load();
        });
        
        // ç­‰å¾…éŸ³é¢‘åŠ è½½å®Œæˆ
        loadPromise.then(function() {
          audioLoaded = true;
          audioEnabled = true;
          document.getElementById('audioStatus').innerHTML = "ğŸ”Š éŸ³é¢‘å·²åŠ è½½";
          document.getElementById('audioStatus').style.color = "#00ff00";
          console.log("MP3éŸ³é¢‘åŠ è½½æˆåŠŸ");
          debugLog("MP3éŸ³é¢‘å·²å°±ç»ª");
          
          // æµ‹è¯•æ’­æ”¾ï¼ˆé™éŸ³ï¼‰
          testAudioPlayback();
        }).catch(function(error) {
          console.error("éŸ³é¢‘åŠ è½½å¤±è´¥:", error);
          debugLog("éŸ³é¢‘åŠ è½½å¤±è´¥: " + error.message);
          // æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
          showAudioError(error.message);
        });
        
      } catch (error) {
        console.error("éŸ³é¢‘åˆå§‹åŒ–å¤±è´¥:", error);
        debugLog("éŸ³é¢‘åˆå§‹åŒ–å¤±è´¥: " + error.message);
      }
    }

    // æµ‹è¯•éŸ³é¢‘æ’­æ”¾
    function testAudioPlayback() {
      if (!clickAudio || !audioLoaded) return;
      
      try {
        // åˆ›å»ºä¸€ä¸ªæµ‹è¯•æ’­æ”¾ï¼ˆé™éŸ³ï¼‰
        var testAudio = clickAudio.cloneNode();
        testAudio.volume = 0; // é™éŸ³æµ‹è¯•
        testAudio.play().then(function() {
          console.log("éŸ³é¢‘æµ‹è¯•æ’­æ”¾æˆåŠŸ");
          testAudio.pause();
        }).catch(function(error) {
          console.warn("éŸ³é¢‘æµ‹è¯•æ’­æ”¾å¤±è´¥:", error);
        });
      } catch (error) {
        console.warn("éŸ³é¢‘æµ‹è¯•å¤±è´¥:", error);
      }
    }

    // æ˜¾ç¤ºéŸ³é¢‘é”™è¯¯ä¿¡æ¯
    function showAudioError(message) {
      var errorHTML = `
        <div style="color: #ff6b6b; margin-top: 10px; font-size: 12px;">
          éŸ³é¢‘åŠ è½½é—®é¢˜:<br/>
          ${message}<br/>
          è¯·æ£€æŸ¥:<br/>
          1. éŸ³é¢‘æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®<br/>
          2. æ–‡ä»¶æ˜¯å¦å­˜åœ¨<br/>
          3. æœåŠ¡å™¨æ˜¯å¦å…è®¸è®¿é—®éŸ³é¢‘æ–‡ä»¶
        </div>
      `;
      document.getElementById('audioStatus').innerHTML = "âŒ éŸ³é¢‘åŠ è½½å¤±è´¥" + errorHTML;
    }

    // æ’­æ”¾ç‚¹å‡»éŸ³æ•ˆ
    function playClickSound() {
      if (!audioEnabled || !audioLoaded || !clickAudio) {
        debugLog("éŸ³é¢‘æœªå°±ç»ªï¼Œæ— æ³•æ’­æ”¾");
        return;
      }
      
      try {
        console.log("å°è¯•æ’­æ”¾MP3éŸ³é¢‘");
        debugLog("å‡†å¤‡æ’­æ”¾éŸ³é¢‘");
        
        // åœæ­¢å¹¶é‡ç½®éŸ³é¢‘
        clickAudio.pause();
        clickAudio.currentTime = 0;
        
        // æ’­æ”¾éŸ³é¢‘
        var playPromise = clickAudio.play();
        
        if (playPromise !== undefined) {
          playPromise.then(function() {
            console.log("MP3éŸ³é¢‘æ’­æ”¾æˆåŠŸ");
            debugLog("MP3éŸ³é¢‘æ’­æ”¾æˆåŠŸ");
          }).catch(function(error) {
            console.error("MP3éŸ³é¢‘æ’­æ”¾å¤±è´¥:", error);
            debugLog("æ’­æ”¾å¤±è´¥: " + error.message);
            
            // å°è¯•ä½¿ç”¨Web Audio APIä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
            playFallbackSound();
          });
        }
      } catch (error) {
        console.error("æ’­æ”¾MP3éŸ³é¢‘å¤±è´¥:", error);
        debugLog("æ’­æ”¾å¼‚å¸¸: " + error.message);
        
        // ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
        playFallbackSound();
      }
    }

    // å¤‡ç”¨éŸ³æ•ˆæ–¹æ¡ˆ
    function playFallbackSound() {
      try {
        var audioContext = new (window.AudioContext || window.webkitAudioContext)();
        var oscillator = audioContext.createOscillator();
        var gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(300, audioContext.currentTime + 0.3);
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
        
        console.log("ä½¿ç”¨å¤‡ç”¨éŸ³æ•ˆ");
        debugLog("ä½¿ç”¨å¤‡ç”¨éŸ³æ•ˆ");
      } catch (fallbackError) {
        console.error("å¤‡ç”¨éŸ³æ•ˆä¹Ÿå¤±è´¥:", fallbackError);
        debugLog("æ‰€æœ‰éŸ³æ•ˆæ–¹æ¡ˆéƒ½å¤±è´¥");
      }
    }

    // ç”¨æˆ·äº¤äº’ååˆå§‹åŒ–éŸ³é¢‘
    function initAudioOnUserInteraction() {
      if (!audioEnabled) {
        initAudio();
      }
    }

    //////////////////////////////////////////////////////////////////////////////////
    //		åˆå§‹åŒ–
    //////////////////////////////////////////////////////////////////////////////////

    // åˆå§‹åŒ–WebGLæ¸²æŸ“å™¨
    var renderer = new THREE.WebGLRenderer({
      alpha: true,
      antialias: true,
      preserveDrawingBuffer: true,
    });

    // è®¾ç½®æ¸²æŸ“å™¨ä¸ºå…¨å±
    renderer.setClearColor(new THREE.Color("black"), 0);
    renderer.setPixelRatio(window.devicePixelRatio || 1);
    renderer.setSize(window.innerWidth, window.innerHeight);

    // è®¾ç½®æ¸²æŸ“å™¨DOMå…ƒç´ æ ·å¼ä¸ºå…¨å±è¦†ç›–
    renderer.domElement.style.position = "fixed";
    renderer.domElement.style.top = "0px";
    renderer.domElement.style.left = "0px";
    renderer.domElement.style.width = "100%";
    renderer.domElement.style.height = "100%";
    renderer.domElement.style.zIndex = "1";

    // å°†æ¸²æŸ“å™¨æ·»åŠ åˆ°é¡µé¢
    document.body.appendChild(renderer.domElement);

    // æ¸²æŸ“å¾ªç¯å‡½æ•°æ•°ç»„
    var onRenderFcts = [];

    // åˆå§‹åŒ–3Dåœºæ™¯
    var scene = new THREE.Scene();

    // æ·»åŠ ç¯å¢ƒå…‰
    var ambient = new THREE.AmbientLight(0x666666);
    scene.add(ambient);

    // æ·»åŠ å®šå‘å…‰
    var directionalLight = new THREE.DirectionalLight(0x887766);
    directionalLight.position.set(-1, 1, 1).normalize();
    scene.add(directionalLight);

    //////////////////////////////////////////////////////////////////////////////////
    //		åˆå§‹åŒ–åŸºç¡€ç›¸æœº
    //////////////////////////////////////////////////////////////////////////////////

    // åˆ›å»ºThree.jsç›¸æœº
    var camera = new THREE.Camera();
    scene.add(camera);

    // å°„çº¿æŠ•å°„å™¨
    var raycaster = new THREE.Raycaster();
    var mouse = new THREE.Vector2();

    // å­˜å‚¨å¯ç‚¹å‡»çš„ç‰©ä½“
    var clickableObjects = [];

    // è°ƒè¯•å‡½æ•°
    function debugLog(message) {
      // console.log(message);
      var debugElement = document.getElementById('debugInfo');
      if (debugElement) {
        debugElement.innerHTML = message;
        debugElement.style.display = 'block';
      }
    }

    ////////////////////////////////////////////////////////////////////////////////
    //         å¤„ç†ARè§†é¢‘æº
    ////////////////////////////////////////////////////////////////////////////////

    var arToolkitSource = new THREEx.ArToolkitSource({
      sourceType: "webcam",
    });

    arToolkitSource.init(function onReady() {
      console.log("æ‘„åƒå¤´åˆå§‹åŒ–å®Œæˆ");

      if (arToolkitSource.domElement) {
        arToolkitSource.domElement.style.position = "fixed";
        arToolkitSource.domElement.style.top = "0px";
        arToolkitSource.domElement.style.left = "0px";
        arToolkitSource.domElement.style.width = "100%";
        arToolkitSource.domElement.style.height = "100%";
        arToolkitSource.domElement.style.objectFit = "cover";
        arToolkitSource.domElement.style.zIndex = "0";
      }

      arToolkitSource.onResizeElement(
        [
          renderer.domElement,
          arToolkitContext.arController
            ? arToolkitContext.arController.canvas
            : null,
        ].filter(Boolean)
      );
    });

    window.addEventListener("resize", function () {
      renderer.setSize(window.innerWidth, window.innerHeight);
      arToolkitSource.onResizeElement(
        [
          renderer.domElement,
          arToolkitContext.arController
            ? arToolkitContext.arController.canvas
            : null,
        ].filter(Boolean)
      );
    });

    ////////////////////////////////////////////////////////////////////////////////
    //         åˆå§‹åŒ–ARä¸Šä¸‹æ–‡
    ////////////////////////////////////////////////////////////////////////////////

    var arToolkitContext = new THREEx.ArToolkitContext({
      cameraParametersUrl: "../../../data/data/camera_para.dat",
      detectionMode: "mono",
      maxDetectionRate: 60,
      canvasWidth: 1280,
      canvasHeight: 720,
      debug: false,
    });

    arToolkitContext.init(function onCompleted() {
      console.log("ARä¸Šä¸‹æ–‡åˆå§‹åŒ–å®Œæˆ");
      camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
    });

    onRenderFcts.push(function () {
      if (arToolkitSource.ready === false) return;
      arToolkitContext.update(arToolkitSource.domElement);
    });

    ////////////////////////////////////////////////////////////////////////////////
    //         åˆ›å»ºARæ ‡è®°æ§åˆ¶å™¨
    ////////////////////////////////////////////////////////////////////////////////

    var markerRoot = new THREE.Group();
    markerRoot.visible = false;
    scene.add(markerRoot);

    var markerControls = new THREEx.ArMarkerControls(
      arToolkitContext,
      markerRoot,
      {
        type: "pattern",
        patternUrl: "/AR.js-master-three/data/data/marker.patt",
        size: 1.0,
        smooth: true,
        smoothCount: 5,
        smoothTolerance: 0.01,
        smoothThreshold: 2,
      }
    );

    markerControls.addEventListener("markerFound", function () {
      // console.log("âœ… æ ‡è®°è¯†åˆ«æˆåŠŸ");
      document.getElementById("info").style.display = "none";
      document.getElementById("status").style.display = "block";
      document.getElementById("clickHint").style.display = "block";
      markerRoot.visible = true;
      debugLog("æ ‡è®°è¯†åˆ«æˆåŠŸï¼å¯ä»¥ç‚¹å‡»çƒä½“äº†");
    });

    markerControls.addEventListener("markerLost", function () {
      // console.log("âŒ æ ‡è®°ä¸¢å¤±");
      document.getElementById("status").style.display = "none";
      document.getElementById("info").style.display = "block";
      document.getElementById("clickHint").style.display = "none";
      markerRoot.visible = false;
      debugLog("æ ‡è®°ä¸¢å¤±");
    });

    ////////////////////////////////////////////////////////////////////////////////
    //         åˆ›å»ºå¹³æ»‘æ§åˆ¶å™¨
    ////////////////////////////////////////////////////////////////////////////////

    var smoothedRoot = new THREE.Group();
    smoothedRoot.visible = false;
    scene.add(smoothedRoot);

    var smoothedControls = new THREEx.ArSmoothedControls(smoothedRoot, {
      minVisibleDelay: 0.3,
      minUnvisibleDelay: 0.5,
      smoothDelay: 0.1,
      smoothPosition: 0.8,
      smoothRotation: 0.8,
    });

    smoothedControls.addEventListener("becameVisible", function () {
      console.log("ğŸ‘ï¸ æ¨¡å‹å˜ä¸ºå¯è§");
      smoothedRoot.visible = true;
      debugLog("3Dæ¨¡å‹å·²æ˜¾ç¤º");
    });

    smoothedControls.addEventListener("becameUnVisible", function () {
      console.log("ğŸ™ˆ æ¨¡å‹å˜ä¸ºä¸å¯è§");
      smoothedRoot.visible = false;
      debugLog("3Dæ¨¡å‹å·²éšè—");
    });

    onRenderFcts.push(function (delta) {
      smoothedControls.update(markerRoot);
    });

    //////////////////////////////////////////////////////////////////////////////////
    //		åœ¨åœºæ™¯ä¸­æ·»åŠ 3Dç‰©ä½“
    //////////////////////////////////////////////////////////////////////////////////

    // æ·»åŠ ç¯é¢çº½ç»“
    // var torusGeometry = new THREE.TorusKnotGeometry(0.3, 0.1, 128, 32);
    // var torusMaterial = new THREE.MeshPhongMaterial({
    //   color: 0xff9800,
    //   shininess: 100,
    //   specular: 0x222222,
    // });
    // var torus = new THREE.Mesh(torusGeometry, torusMaterial);
    // torus.position.y = 0.8;
    // smoothedRoot.add(torus);

    var sphereGeometry = new THREE.SphereGeometry(0.2, 32, 32);
    var sphereMaterial = new THREE.MeshPhongMaterial({
      color: 0xe91e63,
      shininess: 100,
      emissive: 0xe91e63,
      emissiveIntensity: 0.3,
    });
    var sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
    sphere.position.set(0.5, 0.5, 0.3);
    
    sphere.userData = { 
      clickable: true, 
      originalColor: 0xe91e63,
      originalScale: 1,
      name: "clickableSphere"
    };
    
    smoothedRoot.add(sphere);
    clickableObjects.push(sphere);

    // æ·»åŠ å¹³å°ä½œä¸ºçƒä½“çš„åº•åº§
    // var platformGeometry = new THREE.CylinderGeometry(0.25, 0.25, 0.05, 16);
    // var platformMaterial = new THREE.MeshPhongMaterial({
    //   color: 0x4fc3f7,
    //   transparent: true,
    //   opacity: 0.8,
    // });
    // var platform = new THREE.Mesh(platformGeometry, platformMaterial);
    // platform.position.set(0.5, 0.3, 0.3);
    // smoothedRoot.add(platform);

    var sphereClicked = false;
    var clickAnimationTime = 0;

    var animationTime = 0;
    onRenderFcts.push(function (delta) {
      animationTime += delta;

      // torus.rotation.x = animationTime * 0.5;
      // torus.rotation.y = animationTime * 0.8;

      if (!sphereClicked) {
        sphere.position.y = 0.5 + Math.sin(animationTime * 2) * 0.1;
      } else {
        clickAnimationTime += delta;
        sphere.rotation.x = clickAnimationTime * 3;
        sphere.rotation.y = clickAnimationTime * 2;
        sphere.scale.setScalar(1 + Math.sin(clickAnimationTime * 5) * 0.2);
      }

      sphere.rotation.z = animationTime * 0.5;
    });

    //////////////////////////////////////////////////////////////////////////////////
    //		æ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†
    //////////////////////////////////////////////////////////////////////////////////

    function checkSphereClick(event) {
      // event.preventDefault();
      
      // åˆå§‹åŒ–éŸ³é¢‘
      initAudioOnUserInteraction();
      
      var mouseX = (event.clientX / window.innerWidth) * 2 - 1;
      var mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
      
      debugLog(`ç‚¹å‡»ä½ç½®: x=${mouseX.toFixed(2)}, y=${mouseY.toFixed(2)}`);

      var sphereWorldPos = new THREE.Vector3();
      sphere.getWorldPosition(sphereWorldPos);
      
      var screenPos = sphereWorldPos.clone();
      screenPos.project(camera);
      
      var screenX = (screenPos.x + 1) / 2 * window.innerWidth;
      var screenY = (-screenPos.y + 1) / 2 * window.innerHeight;
      
      debugLog(`çƒä½“ä½ç½®: x=${screenX.toFixed(0)}, y=${screenY.toFixed(0)}`);

      var distance = Math.sqrt(
        Math.pow(event.clientX - screenX, 2) + 
        Math.pow(event.clientY - screenY, 2)
      );
      
      debugLog(`ç‚¹å‡»è·ç¦»: ${distance.toFixed(0)}px`);

      if (distance < 50) {
        handleSphereClick(sphere);
        debugLog("âœ… æˆåŠŸç‚¹å‡»çƒä½“ï¼");
      } else {
        debugLog("âŒ æœªç‚¹å‡»åˆ°çƒä½“");
      }
    }

    function handleSphereClick(sphere) {
      console.log("ğŸ¯ çƒä½“è¢«ç‚¹å‡»äº†ï¼");
      
      // æ’­æ”¾MP3éŸ³æ•ˆ
      playClickSound();
      
      sphereClicked = !sphereClicked;
      
      showClickEffect();
      
      if (sphereClicked) {
        sphere.material.color.set(0x00ff00);
        sphere.material.emissive.set(0x00ff00);
        sphere.material.emissiveIntensity = 0.5;
        sphere.userData.originalScale = sphere.scale.x;
        document.getElementById("clickHint").innerHTML = "ğŸ’š å†æ¬¡ç‚¹å‡»æ¢å¤åŸçŠ¶";
        document.getElementById("clickHint").style.color = "#00ff00";
      } else {
        sphere.material.color.set(sphere.userData.originalColor);
        sphere.material.emissive.set(sphere.userData.originalColor);
        sphere.material.emissiveIntensity = 0.3;
        sphere.scale.setScalar(sphere.userData.originalScale);
        document.getElementById("clickHint").innerHTML = "ğŸ’¡ ç‚¹å‡»ç²‰è‰²çƒä½“æ’­æ”¾éŸ³é¢‘ï¼";
        document.getElementById("clickHint").style.color = "#4fc3f7";
      }
    }

    function showClickEffect() {
      var effectElement = document.getElementById("clickEffect");
      effectElement.style.display = "block";
      effectElement.style.opacity = "1";
      effectElement.style.transform = "translate(-50%, -50%) scale(1)";
      
      var startTime = Date.now();
      var duration = 1000;
      
      function animateEffect() {
        var elapsed = Date.now() - startTime;
        var progress = elapsed / duration;
        
        if (progress < 1) {
          effectElement.style.transform = `translate(-50%, -50%) scale(${1 + progress * 0.5})`;
          effectElement.style.opacity = (1 - progress).toString();
          requestAnimationFrame(animateEffect);
        } else {
          effectElement.style.display = "none";
        }
      }
      
      animateEffect();
    }

    // æ·»åŠ å…¨å±€ç‚¹å‡»äº‹ä»¶æ¥å¯ç”¨éŸ³é¢‘
    document.addEventListener('click', function(event) {
      initAudioOnUserInteraction();
      debugLog("ç”¨æˆ·ç‚¹å‡»é¡µé¢ï¼Œåˆå§‹åŒ–éŸ³é¢‘");
    });

    // çƒä½“ç‚¹å‡»äº‹ä»¶
    window.addEventListener("click", checkSphereClick, false);

    // è§¦æ‘¸è®¾å¤‡æ”¯æŒ
    window.addEventListener("touchstart", function(event) {
      if (event.touches.length === 1) {
        checkSphereClick(event.touches[0]);
      }
    }, false);

    //////////////////////////////////////////////////////////////////////////////////
    //		æ¸²æŸ“åœºæ™¯
    //////////////////////////////////////////////////////////////////////////////////

    var stats = new Stats();
    stats.dom.style.position = "fixed";
    stats.dom.style.top = "60px";
    stats.dom.style.left = "10px";
    stats.dom.style.zIndex = "100";
    document.body.appendChild(stats.dom);

    onRenderFcts.push(function () {
      renderer.render(scene, camera);
      stats.update();
    });

    var lastTimeMsec = null;
    requestAnimationFrame(function animate(nowMsec) {
      requestAnimationFrame(animate);
      lastTimeMsec = lastTimeMsec || nowMsec - 1000 / 60;
      var deltaMsec = Math.min(200, nowMsec - lastTimeMsec);
      lastTimeMsec = nowMsec;
      onRenderFcts.forEach(function (onRenderFct) {
        onRenderFct(deltaMsec / 1000, nowMsec / 1000);
      });
    });

    document.addEventListener("visibilitychange", function () {
      if (!document.hidden) {
        console.log("é¡µé¢é‡æ–°æ¿€æ´»ï¼Œé‡æ–°åˆå§‹åŒ–AR");
        arToolkitSource.init(function onReady() {
          arToolkitSource.onResizeElement(
            [
              renderer.domElement,
              arToolkitContext.arController
                ? arToolkitContext.arController.canvas
                : null,
            ].filter(Boolean)
          );
        });
      }
    });

    console.log("ARåº”ç”¨åˆå§‹åŒ–å®Œæˆ");
    debugLog("åº”ç”¨å·²å¯åŠ¨ - ç‚¹å‡»é¡µé¢ä»»æ„ä½ç½®å¯ç”¨éŸ³é¢‘");
  </script>
</body>