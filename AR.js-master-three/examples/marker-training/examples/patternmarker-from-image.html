<!DOCTYPE html>
<meta
  name="viewport"
  content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
/>
<!-- three.js library -->
<script src="../../vendor/three.js/build/three.js"></script>
<script src="../../vendor/three.js/examples/js/libs/stats.min.js"></script>
<!-- jsartookit -->
<script src="../../../vendor/jsartoolkit5/build/artoolkit.min.js"></script>
<script src="../../../vendor/jsartoolkit5/js/artoolkit.api.js"></script>
<!-- include threex.artoolkit -->
<script src="../../../src/threex/threex-artoolkitsource.js"></script>
<script src="../../../src/threex/threex-artoolkitcontext.js"></script>
<script src="../../../src/threex/threex-artoolkitprofile.js"></script>
<script src="../../../src/threex/threex-arbasecontrols.js"></script>
<script src="../../../src/threex/threex-armarkercontrols.js"></script>
<script src="../../../src/threex/threex-arsmoothedcontrols.js"></script>
<script>
  THREEx.ArToolkitContext.baseURL = "../../../";
</script>

<!-- include THREEx.ArPatternFile -->
<script src="../threex-arpatternfile.js"></script>

<body style="margin: 0px; overflow: hidden; font-family: Monospace">
  <div
    style="
      position: absolute;
      top: 10px;
      width: 100%;
      text-align: center;
      z-index: 1;
    "
  >
    <a href="https://github.com/jeromeetienne/AR.js/" target="_blank">AR.js</a>
    - developement playground
    <br />
    Contact me any time at
    <a href="https://twitter.com/jerome_etienne" target="_blank"
      >@jerome_etienne</a
    >
  </div>

  <!-- 提示信息 -->
  <div
    id="info"
    style="
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      z-index: 100;
    "
  >
    请将摄像头对准标记物
  </div>

  <script>
    //////////////////////////////////////////////////////////////////////////////////
    //		Init
    //////////////////////////////////////////////////////////////////////////////////

    // init renderer
    var renderer = new THREE.WebGLRenderer({
      alpha: true,
    });
    renderer.setClearColor(new THREE.Color("lightgrey"), 0);
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.domElement.style.position = "absolute";
    renderer.domElement.style.top = "0px";
    renderer.domElement.style.left = "0px";
    document.body.appendChild(renderer.domElement);

    // array of functions for the rendering loop
    var onRenderFcts = [];

    // init scene and camera
    var scene = new THREE.Scene();

    var ambient = new THREE.AmbientLight(0x666666);
    scene.add(ambient);

    var directionalLight = new THREE.DirectionalLight(0x887766);
    directionalLight.position.set(-1, 1, 1).normalize();
    scene.add(directionalLight);

    //////////////////////////////////////////////////////////////////////////////////
    //		Initialize a basic camera
    //////////////////////////////////////////////////////////////////////////////////

    // Create a camera
    var camera = new THREE.Camera();
    scene.add(camera);

    ////////////////////////////////////////////////////////////////////////////////
    //          handle arToolkitSource
    ////////////////////////////////////////////////////////////////////////////////

    var arToolkitSource = new THREEx.ArToolkitSource({
      // to read from the webcam
      sourceType: "webcam",
    });

    arToolkitSource.init(function onReady() {
      // handle resize of renderer
      arToolkitSource.onResizeElement([
        renderer.domElement,
        arToolkitContext.arController.canvas,
      ]);
    });

    // handle resize
    window.addEventListener("resize", function () {
      // handle arToolkitSource resize
      arToolkitSource.onResizeElement([
        renderer.domElement,
        arToolkitContext.arController.canvas,
      ]);
    });

    ////////////////////////////////////////////////////////////////////////////////
    //          initialize arToolkitContext
    ////////////////////////////////////////////////////////////////////////////////

    // create atToolkitContext
    var arToolkitContext = new THREEx.ArToolkitContext({
      cameraParametersUrl: "../../../data/data/camera_para.dat",
      detectionMode: "mono",
      canvasWidth: 80 * 3,
      canvasHeight: 60 * 3,
    });
    // initialize it
    arToolkitContext.init(function onCompleted() {
      // copy projection matrix to camera
      camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
    });

    // update artoolkit on every frame
    onRenderFcts.push(function () {
      if (arToolkitSource.ready === false) return;
      arToolkitContext.update(arToolkitSource.domElement);
    });

    ////////////////////////////////////////////////////////////////////////////////
    //          Create a ArMarkerControls
    ////////////////////////////////////////////////////////////////////////////////

    var markerRoot = new THREE.Group();
    markerRoot.visible = false;  // 初始隐藏标记根节点
    scene.add(markerRoot);

    // load image and convert it to a marker
    var imageURL = "../inner-images/inner-hiro.png";
    THREEx.ArPatternFile.encodeImageURL(
      imageURL,
      function onComplete(patternFileString) {
        var patternURL = "data:text/plain;base64," + btoa(patternFileString);
        console.log(`output->patternURL`, patternURL);
        
        // create THREEx.ArMarkerControls
        var markerControls = new THREEx.ArMarkerControls(
          arToolkitContext,
          markerRoot,
          {
            type: "pattern",
            patternUrl: patternURL,
            size: 1.0
          }
        );
        
        // 添加标记事件监听
        markerControls.addEventListener('markerFound', function() {
          console.log('标记物识别成功');
          document.getElementById('info').style.display = 'none';
        });
        
        markerControls.addEventListener('markerLost', function() {
          console.log('标记物丢失');
          document.getElementById('info').style.display = 'block';
        });
      }
    );

    // build a smoothedControls
    var smoothedRoot = new THREE.Group();
    smoothedRoot.visible = false;  // 初始隐藏平滑根节点
    scene.add(smoothedRoot);
    
    var smoothedControls = new THREEx.ArSmoothedControls(smoothedRoot, {
      minVisibleDelay: 0.5,    // 显示延迟
      minUnvisibleDelay: 0.5,  // 隐藏延迟
    });
    
    // 添加平滑控制器的可见性事件监听
    smoothedControls.addEventListener('becameVisible', function(){
      console.log('模型变为可见');
      smoothedRoot.visible = true;
    });
    
    smoothedControls.addEventListener('becameUnVisible', function(){
      console.log('模型变为不可见');
      smoothedRoot.visible = false;
    });
    
    onRenderFcts.push(function (delta) {
      smoothedControls.update(markerRoot);
    });

    //////////////////////////////////////////////////////////////////////////////////
    //		add an object in the scene
    //////////////////////////////////////////////////////////////////////////////////

    // 添加坐标轴
    var axes = new THREE.AxesHelper(1);
    smoothedRoot.add(axes);

    // 添加半透明立方体
    var cubeGeometry = new THREE.BoxGeometry(1, 1, 1);
    var cubeMaterial = new THREE.MeshNormalMaterial({
      transparent: true,
      opacity: 0.5,
      side: THREE.DoubleSide,
    });
    var cube = new THREE.Mesh(cubeGeometry, cubeMaterial);
    cube.position.y = cubeGeometry.parameters.height / 2;
    smoothedRoot.add(cube);

    // 添加环面纽结
    var torusGeometry = new THREE.TorusKnotGeometry(0.3, 0.1, 64, 16);
    var torusMaterial = new THREE.MeshNormalMaterial();
    var torus = new THREE.Mesh(torusGeometry, torusMaterial);
    torus.position.y = 1.0;
    smoothedRoot.add(torus);

    // 添加动画
    onRenderFcts.push(function (delta) {
      torus.rotation.x += delta * Math.PI;
      cube.rotation.y += delta * Math.PI * 0.5;
    });

    //////////////////////////////////////////////////////////////////////////////////
    //		render the whole thing on the page
    //////////////////////////////////////////////////////////////////////////////////
    var stats = new Stats();
    document.body.appendChild(stats.dom);
    
    // render the scene
    onRenderFcts.push(function () {
      renderer.render(scene, camera);
      stats.update();
    });

    // run the rendering loop
    var lastTimeMsec = null;
    requestAnimationFrame(function animate(nowMsec) {
      // keep looping
      requestAnimationFrame(animate);
      // measure time
      lastTimeMsec = lastTimeMsec || nowMsec - 1000 / 60;
      var deltaMsec = Math.min(200, nowMsec - lastTimeMsec);
      lastTimeMsec = nowMsec;
      // call each update function
      onRenderFcts.forEach(function (onRenderFct) {
        onRenderFct(deltaMsec / 1000, nowMsec / 1000);
      });
    });

    // 处理页面可见性变化
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden) {
        // 页面重新可见时，重新初始化AR源
        arToolkitSource.init(function onReady() {
          arToolkitSource.onResizeElement([
            renderer.domElement,
            arToolkitContext.arController.canvas,
          ]);
        });
      }
    });
  </script>
</body>