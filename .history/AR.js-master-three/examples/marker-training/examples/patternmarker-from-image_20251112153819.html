<!DOCTYPE html>
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
<!-- three.js 3Dæ¸²æŸ“åº“ -->
<script src="../../vendor/three.js/build/three.js"></script>
<script src="../../vendor/three.js/examples/js/libs/stats.min.js"></script>
<!-- ARToolKit å¢å¼ºç°å®åº“ -->
<script src="../../../vendor/jsartoolkit5/build/artoolkit.min.js"></script>
<script src="../../../vendor/jsartoolkit5/js/artoolkit.api.js"></script>
<!-- å¼•å…¥ threex.artoolkit æ‰©å±• -->
<script src="../../../src/threex/threex-artoolkitsource.js"></script>
<script src="../../../src/threex/threex-artoolkitcontext.js"></script>
<script src="../../../src/threex/threex-artoolkitprofile.js"></script>
<script src="../../../src/threex/threex-arbasecontrols.js"></script>
<script src="../../../src/threex/threex-armarkercontrols.js"></script>
<script src="../../../src/threex/threex-arsmoothedcontrols.js"></script>
<script>
	THREEx.ArToolkitContext.baseURL = "../../../";
</script>

<!-- å¼•å…¥å›¾æ¡ˆæ–‡ä»¶å¤„ç† -->
<script src="../threex-arpatternfile.js"></script>
<!-- éƒ¨ç½²æµ‹è¯•ç¯å¢ƒæ—¶æ”¾å¼€ vconsole ç”¨äºæµ‹è¯•  -->
<script src="https://cdn.banyou.70180.cn/assets/xcontent/vconsole/vconsole.min.js"></script>
<script>
	let vConsole = new window.VConsole();
</script>

<body style="
    margin: 0px;
    overflow: hidden;
    font-family: Monospace;
    background: black;
  ">
	<!-- ä½¿ç”¨æç¤º -->
	<div id="info" style="
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      z-index: 100;
      font-size: 18px;
      border: 2px solid #4fc3f7;
      box-shadow: 0 0 20px rgba(79, 195, 247, 0.5);
    ">
		<div style="font-size: 24px; margin-bottom: 15px; color: #4fc3f7">
			ğŸ” ARå¢å¼ºç°å®æ¼”ç¤º
		</div>
		è¯·å°†æ‘„åƒå¤´å¯¹å‡†ARæ ‡è®°å›¾æ¡ˆ<br />
		<small style="color: #b0bec5">æ¨¡å‹å°†åœ¨è¯†åˆ«åˆ°æ ‡è®°åæ˜¾ç¤º</small>
	</div>

	<!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
	<div id="status" style="
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px 15px;
      border-radius: 20px;
      z-index: 100;
      font-size: 14px;
      display: none;
    ">
		âœ… æ ‡è®°å·²è¯†åˆ«
	</div>

	<script>
		//////////////////////////////////////////////////////////////////////////////////
		//		åˆå§‹åŒ–
		//////////////////////////////////////////////////////////////////////////////////

		// åˆå§‹åŒ–WebGLæ¸²æŸ“å™¨
		var renderer = new THREE.WebGLRenderer({
			alpha: true, // å¯ç”¨é€æ˜èƒŒæ™¯
			antialias: true, // å¯ç”¨æŠ—é”¯é½¿
			preserveDrawingBuffer: true, // ä¿ç•™ç»˜å›¾ç¼“å†²åŒº
		});

		// è®¾ç½®æ¸²æŸ“å™¨ä¸ºå…¨å±
		renderer.setClearColor(new THREE.Color("black"), 0); // é»‘è‰²èƒŒæ™¯
		renderer.setPixelRatio(window.devicePixelRatio || 1); // æ”¯æŒé«˜DPIå±å¹•
		renderer.setSize(window.innerWidth, window.innerHeight); // å…¨å±å°ºå¯¸

		// è®¾ç½®æ¸²æŸ“å™¨DOMå…ƒç´ æ ·å¼ä¸ºå…¨å±è¦†ç›–
		renderer.domElement.style.position = "fixed";
		renderer.domElement.style.top = "0px";
		renderer.domElement.style.left = "0px";
		renderer.domElement.style.width = "100%";
		renderer.domElement.style.height = "100%";
		renderer.domElement.style.zIndex = "1";

		// å°†æ¸²æŸ“å™¨æ·»åŠ åˆ°é¡µé¢
		document.body.appendChild(renderer.domElement);

		// æ¸²æŸ“å¾ªç¯å‡½æ•°æ•°ç»„
		var onRenderFcts = [];

		// åˆå§‹åŒ–3Dåœºæ™¯
		var scene = new THREE.Scene();

		// æ·»åŠ ç¯å¢ƒå…‰
		var ambient = new THREE.AmbientLight(0x666666);
		scene.add(ambient);

		// æ·»åŠ å®šå‘å…‰
		var directionalLight = new THREE.DirectionalLight(0x887766);
		directionalLight.position.set(-1, 1, 1).normalize();
		scene.add(directionalLight);

		//////////////////////////////////////////////////////////////////////////////////
		//		åˆå§‹åŒ–åŸºç¡€ç›¸æœº
		//////////////////////////////////////////////////////////////////////////////////

		// åˆ›å»ºThree.jsç›¸æœºï¼ˆæŠ•å½±çŸ©é˜µå°†ç”±ARToolKitè®¾ç½®ï¼‰
		var camera = new THREE.Camera();
		scene.add(camera);

		////////////////////////////////////////////////////////////////////////////////
		//         å¤„ç†ARè§†é¢‘æº
		////////////////////////////////////////////////////////////////////////////////

		// åˆ›å»ºARè§†é¢‘æºï¼ˆä½¿ç”¨æ‘„åƒå¤´ï¼‰
		var arToolkitSource = new THREEx.ArToolkitSource({
			sourceType: "webcam", // ä½¿ç”¨æ‘„åƒå¤´ä½œä¸ºè§†é¢‘æº

			// å¯é€‰ï¼šä½¿ç”¨å›¾ç‰‡
			// sourceType : 'image',
			// sourceUrl : THREEx.ArToolkitContext.baseURL + '../data/images/img.jpg',

			// å¯é€‰ï¼šä½¿ç”¨è§†é¢‘æ–‡ä»¶
			// sourceType : 'video',
			// sourceUrl : THREEx.ArToolkitContext.baseURL + '../data/videos/headtracking.mp4',
		});

		// åˆå§‹åŒ–è§†é¢‘æº
		arToolkitSource.init(function onReady() {
			console.log("æ‘„åƒå¤´åˆå§‹åŒ–å®Œæˆ");

			// è®¾ç½®è§†é¢‘å…ƒç´ ä¸ºå…¨å±
			if (arToolkitSource.domElement) {
				arToolkitSource.domElement.style.position = "fixed";
				arToolkitSource.domElement.style.top = "0px";
				arToolkitSource.domElement.style.left = "0px";
				arToolkitSource.domElement.style.width = "100%";
				arToolkitSource.domElement.style.height = "100%";
				arToolkitSource.domElement.style.objectFit = "cover"; // ä¿æŒæ¯”ä¾‹å¹¶è¦†ç›–æ•´ä¸ªåŒºåŸŸ
				arToolkitSource.domElement.style.zIndex = "0";
			}

			// å¤„ç†æ¸²æŸ“å™¨å’ŒARç”»å¸ƒçš„å¤§å°è°ƒæ•´
			arToolkitSource.onResizeElement(
				[
					renderer.domElement,
					arToolkitContext.arController
						? arToolkitContext.arController.canvas
						: null,
				].filter(Boolean)
			);
		});

		// å¤„ç†çª—å£å¤§å°å˜åŒ–
		window.addEventListener("resize", function () {
			// æ›´æ–°æ¸²æŸ“å™¨å¤§å°ä¸ºå…¨å±
			renderer.setSize(window.innerWidth, window.innerHeight);

			// å¤„ç†ARè§†é¢‘æºå¤§å°è°ƒæ•´
			arToolkitSource.onResizeElement(
				[
					renderer.domElement,
					arToolkitContext.arController
						? arToolkitContext.arController.canvas
						: null,
				].filter(Boolean)
			);
		});

		////////////////////////////////////////////////////////////////////////////////
		//         åˆå§‹åŒ–ARä¸Šä¸‹æ–‡
		////////////////////////////////////////////////////////////////////////////////

		// åˆ›å»ºARå·¥å…·åŒ…ä¸Šä¸‹æ–‡
		var arToolkitContext = new THREEx.ArToolkitContext({
			cameraParametersUrl: "../../../data/data/camera_para.dat", // ç›¸æœºå‚æ•°æ–‡ä»¶
			detectionMode: "mono", // å•ç›®æ£€æµ‹æ¨¡å¼
			maxDetectionRate: 60, // æœ€å¤§æ£€æµ‹ç‡
			canvasWidth: 1280, // å¢åŠ ç”»å¸ƒå®½åº¦ä»¥æé«˜æ£€æµ‹ç²¾åº¦
			canvasHeight: 720, // å¢åŠ ç”»å¸ƒé«˜åº¦
			debug: false, // å…³é—­è°ƒè¯•æ¨¡å¼
		});

		// åˆå§‹åŒ–ARä¸Šä¸‹æ–‡
		arToolkitContext.init(function onCompleted() {
			console.log("ARä¸Šä¸‹æ–‡åˆå§‹åŒ–å®Œæˆ");
			// å°†ARæŠ•å½±çŸ©é˜µå¤åˆ¶åˆ°Three.jsç›¸æœº
			camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
		});

		// æ¯å¸§æ›´æ–°ARå·¥å…·åŒ…
		onRenderFcts.push(function () {
			if (arToolkitSource.ready === false) return;
			arToolkitContext.update(arToolkitSource.domElement);
		});

		////////////////////////////////////////////////////////////////////////////////
		//         åˆ›å»ºARæ ‡è®°æ§åˆ¶å™¨
		////////////////////////////////////////////////////////////////////////////////

		// åˆ›å»ºæ ‡è®°æ ¹ç»„ï¼ˆç”¨äºæ”¾ç½®è¯†åˆ«åˆ°çš„æ ‡è®°ï¼‰
		var markerRoot = new THREE.Group();
		markerRoot.visible = false; // åˆå§‹éšè—
		scene.add(markerRoot);

		// åŠ è½½å›¾ç‰‡å¹¶è½¬æ¢ä¸ºæ ‡è®°å›¾æ¡ˆ
		var imageURL = "data/data/marker.patt";
		THREEx.ArPatternFile.encodeImageURL(
			imageURL,
			function onComplete(patternFileString) {
				// å°†å›¾æ¡ˆæ–‡ä»¶è½¬æ¢ä¸ºBase64 URL
				var patternURL = "data:text/plain;base64," + btoa(patternFileString);
				console.log("å›¾æ¡ˆURLç”Ÿæˆå®Œæˆ:", patternURL);

				// åˆ›å»ºARæ ‡è®°æ§åˆ¶å™¨
				var markerControls = new THREEx.ArMarkerControls(
					arToolkitContext,
					markerRoot,
					{
						type: "pattern", // å›¾æ¡ˆç±»å‹æ ‡è®°
						patternUrl: patternURL, // å›¾æ¡ˆæ–‡ä»¶URL
						size: 1.0, // æ ‡è®°ç‰©ç†å°ºå¯¸ï¼ˆç±³ï¼‰
						smooth: true, // å¯ç”¨å¹³æ»‘
						smoothCount: 5, // å¹³æ»‘å¸§æ•°
						smoothTolerance: 0.01, // å¹³æ»‘å®¹å·®
						smoothThreshold: 2, // å¹³æ»‘é˜ˆå€¼
					}
				);

				// æ·»åŠ æ ‡è®°æ‰¾åˆ°äº‹ä»¶ç›‘å¬
				markerControls.addEventListener("markerFound", function () {
					console.log("âœ… æ ‡è®°è¯†åˆ«æˆåŠŸ");
					document.getElementById("info").style.display = "none";
					document.getElementById("status").style.display = "block";
					markerRoot.visible = true;
				});

				// æ·»åŠ æ ‡è®°ä¸¢å¤±äº‹ä»¶ç›‘å¬
				markerControls.addEventListener("markerLost", function () {
					console.log("âŒ æ ‡è®°ä¸¢å¤±");
					document.getElementById("status").style.display = "none";
					document.getElementById("info").style.display = "block";
				});
			}
		);

		////////////////////////////////////////////////////////////////////////////////
		//         åˆ›å»ºå¹³æ»‘æ§åˆ¶å™¨
		////////////////////////////////////////////////////////////////////////////////

		// åˆ›å»ºå¹³æ»‘æ ¹ç»„ï¼ˆç”¨äºæ”¾ç½®3Dæ¨¡å‹ï¼‰
		var smoothedRoot = new THREE.Group();
		smoothedRoot.visible = false; // åˆå§‹éšè—
		scene.add(smoothedRoot);

		// åˆ›å»ºå¹³æ»‘æ§åˆ¶å™¨ï¼ˆå‡å°‘ARè·Ÿè¸ªæŠ–åŠ¨ï¼‰
		var smoothedControls = new THREEx.ArSmoothedControls(smoothedRoot, {
			minVisibleDelay: 0.3, // æœ€å°å¯è§å»¶è¿Ÿï¼ˆç§’ï¼‰
			minUnvisibleDelay: 0.5, // æœ€å°ä¸å¯è§å»¶è¿Ÿï¼ˆç§’ï¼‰
			smoothDelay: 0.1, // å¹³æ»‘å»¶è¿Ÿ
			smoothPosition: 0.8, // ä½ç½®å¹³æ»‘åº¦
			smoothRotation: 0.8, // æ—‹è½¬å¹³æ»‘åº¦
		});

		// å¹³æ»‘æ§åˆ¶å™¨å˜ä¸ºå¯è§äº‹ä»¶
		smoothedControls.addEventListener("becameVisible", function () {
			console.log("ğŸ‘ï¸ æ¨¡å‹å˜ä¸ºå¯è§");
			smoothedRoot.visible = true;
		});

		// å¹³æ»‘æ§åˆ¶å™¨å˜ä¸ºä¸å¯è§äº‹ä»¶
		smoothedControls.addEventListener("becameUnVisible", function () {
			console.log("ğŸ™ˆ æ¨¡å‹å˜ä¸ºä¸å¯è§");
			smoothedRoot.visible = false;
		});

		// æ¯å¸§æ›´æ–°å¹³æ»‘æ§åˆ¶å™¨
		onRenderFcts.push(function (delta) {
			smoothedControls.update(markerRoot);
		});

		//////////////////////////////////////////////////////////////////////////////////
		//		åœ¨åœºæ™¯ä¸­æ·»åŠ 3Dç‰©ä½“
		//////////////////////////////////////////////////////////////////////////////////

		// æ·»åŠ åæ ‡è½´åŠ©æ‰‹ï¼ˆæ˜¾ç¤ºæ–¹å‘ï¼‰
		var axes = new THREE.AxesHelper(1.5);
		smoothedRoot.add(axes);

		// æ·»åŠ åŠé€æ˜ç«‹æ–¹ä½“å¹³å°
		var cubeGeometry = new THREE.BoxGeometry(1, 0.1, 1); // æ‰å¹³ç«‹æ–¹ä½“ä½œä¸ºå¹³å°
		var cubeMaterial = new THREE.MeshPhongMaterial({
			color: 0x4fc3f7,
			transparent: true,
			opacity: 0.8,
			shininess: 100,
		});
		var cube = new THREE.Mesh(cubeGeometry, cubeMaterial);
		cube.position.y = 0.05; // ç¨å¾®æŠ¬å‡
		smoothedRoot.add(cube);

		// æ·»åŠ ç¯é¢çº½ç»“ï¼ˆä¸»è¦3Dæ¨¡å‹ï¼‰
		var torusGeometry = new THREE.TorusKnotGeometry(0.3, 0.1, 128, 32);
		var torusMaterial = new THREE.MeshPhongMaterial({
			color: 0xff9800,
			shininess: 100,
			specular: 0x222222,
		});
		var torus = new THREE.Mesh(torusGeometry, torusMaterial);
		torus.position.y = 0.8;
		smoothedRoot.add(torus);

		// æ·»åŠ æµ®åŠ¨çƒä½“
		var sphereGeometry = new THREE.SphereGeometry(0.15, 32, 32);
		var sphereMaterial = new THREE.MeshPhongMaterial({
			color: 0xe91e63,
			shininess: 100,
		});
		var sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
		sphere.position.set(0.5, 0.4, 0.3);
		smoothedRoot.add(sphere);

		// æ·»åŠ åŠ¨ç”»æ•ˆæœ
		var animationTime = 0;
		onRenderFcts.push(function (delta) {
			animationTime += delta;

			// ç¯é¢çº½ç»“æ—‹è½¬
			torus.rotation.x = animationTime * 0.5;
			torus.rotation.y = animationTime * 0.8;

			// çƒä½“æµ®åŠ¨åŠ¨ç”»
			sphere.position.y = 0.4 + Math.sin(animationTime * 2) * 0.1;
			sphere.rotation.x = animationTime;
			sphere.rotation.z = animationTime * 0.5;

			// å¹³å°è½»å¾®æ—‹è½¬
			cube.rotation.y = animationTime * 0.2;
		});

		//////////////////////////////////////////////////////////////////////////////////
		//		æ¸²æŸ“åœºæ™¯
		//////////////////////////////////////////////////////////////////////////////////

		// æ·»åŠ æ€§èƒ½ç›‘æ§
		var stats = new Stats();
		stats.dom.style.position = "fixed";
		stats.dom.style.top = "60px";
		stats.dom.style.left = "10px";
		stats.dom.style.zIndex = "100";
		document.body.appendChild(stats.dom);

		// æ¸²æŸ“åœºæ™¯å‡½æ•°
		onRenderFcts.push(function () {
			renderer.render(scene, camera);
			stats.update();
		});

		// è¿è¡ŒåŠ¨ç”»å¾ªç¯
		var lastTimeMsec = null;
		requestAnimationFrame(function animate(nowMsec) {
			// ä¿æŒå¾ªç¯
			requestAnimationFrame(animate);

			// è®¡ç®—æ—¶é—´å¢é‡
			lastTimeMsec = lastTimeMsec || nowMsec - 1000 / 60;
			var deltaMsec = Math.min(200, nowMsec - lastTimeMsec);
			lastTimeMsec = nowMsec;

			// è°ƒç”¨æ¯ä¸ªæ¸²æŸ“å‡½æ•°
			onRenderFcts.forEach(function (onRenderFct) {
				onRenderFct(deltaMsec / 1000, nowMsec / 1000);
			});
		});

		// å¤„ç†é¡µé¢å¯è§æ€§å˜åŒ–ï¼ˆæ ‡ç­¾é¡µåˆ‡æ¢ï¼‰
		document.addEventListener("visibilitychange", function () {
			if (!document.hidden) {
				console.log("é¡µé¢é‡æ–°æ¿€æ´»ï¼Œé‡æ–°åˆå§‹åŒ–AR");
				// é¡µé¢é‡æ–°å¯è§æ—¶ï¼Œé‡æ–°åˆå§‹åŒ–ARæº
				arToolkitSource.init(function onReady() {
					arToolkitSource.onResizeElement(
						[
							renderer.domElement,
							arToolkitContext.arController
								? arToolkitContext.arController.canvas
								: null,
						].filter(Boolean)
					);
				});
			}
		});
		console.log("ARåº”ç”¨åˆå§‹åŒ–å®Œæˆï¼Œç­‰å¾…æ ‡è®°è¯†åˆ«...");
	</script>
</body>